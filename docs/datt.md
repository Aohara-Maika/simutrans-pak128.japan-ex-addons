# datt.rb

datt.rbは、元々wa-st氏が作成した、datファイルの重複部分を書きやすくするためのスクリプトです。これをsou7が改良し、機能を追加しました。

## 使い方

基本的に、元のdatファイルの拡張子をdattに変更するだけで使用できます。`abc=xyz`のような代入や、`---`のような区切り、コメント行はそのまま使用できます。

dattファイルでは、その他にリソース・ディレクティブ・マクロ展開・Excel読み込みなどの機能が追加されています。これらの機能を活用して、datファイルの重複部分を効率的に管理したり、Excelファイルからパラメータを読み込んだりできます。

### ブロック

`---`のような`-`で始まる行で区切られた複数行をブロックと呼びます。例えば、以下のようなdattファイルは3つのブロックに分かれます。

```
# ここは1つ目のブロック
---
# ここは2つ目のブロック
---
# ここは3つ目のブロック
```

### リソース

datの重複部分を管理するために、リソースと呼ばれる機能があります。

特定のブロックをリソースAとして定義し、他のブロックBでそのリソースAを取り込めます。取り込むことで、リソースAに含まれるパラメータの設定をブロックBにコピーします。これにより、同じパラメータを複数のブロックで使い回せるようになります。

このリソースの展開は多段階にすることができ、リソースの中で更に他のリソースを参照することも出来ます。

### ディレクティブ

`%`から始まる行はディレクティブとして扱われます。`%`が2つ以上続く場合は、後に説明する遅延ディレクティブになります。

`%command arg1, args2, ...`の形式でコマンドと引数を指定します。コマンドは以下のようなものがあります。

- `autoname`
  - image属性と、level属性から適当に名前を決定します。
  - JPEXでは使っていません。
- `buil_image`
  - タイル画像用のdatを出力します。
  - JPEXでは使っていません。
- `require`
  - 別のdattファイルを読み込みます。
  - pakを定義するブロックが書いてあるファイルから、リソースを定義しているファイルを読み込むために使います。
  - 例 : `%require 'path/to/file.datt'`
- `include`
  - リソースを取り込みます。
  - 例 : `%include 'resource_name'`
- `require_excel`
  - Excelファイルを読み込みます。`require_excel`で読み込んだExcelのパラメータは、後に説明する`excel`関数を使って参照出来るようになります。
  - 例 : `%require_excel 'path/to/file.xlsx'`
- `addon`
  - 現在のアドオンを追加するかどうかを指定します。
  - 例 : `%addon false`
- `def`
  - 定数を定義します。定義した値は、マクロ展開や他の定数の定義に利用できます。
  - 例 : `%def :constant_name, 1234`
- `undef`
  - 定数・パラメータの設定を削除します。
  - JPEXでは使っていません。
- `resource`
  - 現在のブロックをリソースとして定義します。
  - 例 : `%resource 'resource_name'`
- `ja`
  - jatabファイルを出力します。
  - 例 : `%ja 'サンプルpak'`
- `en`
  - entabファイルを出力します
  - 例 : `%en 'Sample pak'`
- `require_ruby`
  - Rubyファイルを読み込みます。
  - 例 : `%require_ruby 'path/to/file.rb'`
- `lines`
  - 入力された文字列を行単位に分解して、linesに追加します。
  - 例 : `%lines "abc[0]=123\nabc[1]=456\nabc[2]=789"`

### マクロ展開

代入では、右辺左辺問わずマクロ展開が可能です。マクロは`#{`で始まり、`}`で終わります。マクロはRubyのコードとして実行され、結果が展開されます。

例えば、
```
abc=#{1 + 2}
```
というdattファイルがあると、datファイルは
```
abc=3
```
のように展開されます。

`%def`ディレクティブで定義した定数をマクロ展開で利用できます。例えば

```
%def :constant_name, 1234
abc=#{:constant_name}
```
とすると、datファイルは
```
abc=1234
```
のように展開されます。

また、代入パラメータを読み込むことも出来ます。例えば
```
value=xyz
sample=#{'a_' + value + '_b'}
```
とすると、datファイルは
```
sample=a_xyz_b
```
のように展開されます。

マクロ展開で利用できるdatt.rb特有の関数は以下のとおりです。

- `img`
  - image属性からの相対指定。
  - JPEXでは使っていません。
- `excel`
  - Excelファイルから読み込んだパラメータを参照します。
  - Excelファイルの当該セルが空の場合は、nilが帰ります。
  - 例 : `#{excel('sample_value')}`
  - 例 : `#{excel('sample_value') || 'default_value'}`
- `excel!`
  - Excelファイルから読み込んだパラメータを参照します。
  - Excelファイルの当該セルが空の場合は、例外が発生します。
  - 例 : `#{excel!('sample_value')}`

### 遅延ディレクティブ

`%`が2つ以上続く行は遅延ディレクティブとして扱われます。遅延ディレクティブは、そのファイルが読み込まれたときに評価されるのではなく、`%include`ディレクティブによって取り込まれたときに、`%`を1つ外して評価されます。`%`が2つの場合は、最初の取り込み後に評価されます。`%`が3つの場合は、`%include`が多重に行われたときの2回目の取り込み後に評価されます。

### Excel連携

`%require_excel`ディレクティブでExcelファイルを読みこむと、その中のparametersシートの内容を読み込みます。parametersシートは以下の形式に沿っている必要があります。

- 1行目はヘッダー行で、各列の名前を指定します。
- 2行目は無視されます。値の説明を書くために使います。
- 1行目の`name`が入っている列は、各pakファイルの名前となります。

|value1|name|value2|...|
|---|---|---|---|
|1|sample1|aaa|...|
|2|sample2|bbb|...|

`name=sample1`のが定義されたブロックにおいて`excel('value1')`を実行すると、`name`の列が`sample1`の行の中から、`value1`の列のセルの値を取得します。今回であれば2が取得されます。

`excel`関数は、Excelファイルのセルの値が空の場合には`nil`を返します。デフォルト値を設定する場合には、`excel('value1') || 'default_value'`のように書くことができます。

`excel!`関数は、Excelファイルのセルの値が空の場合に例外を発生させます。例外を発生させてエラーを出すことで、ミスを早期に発見できます。

## 作業の流れ

1. リソースを定義するdattファイルAを作成します。
2. datファイルの拡張子をdattに変更し、dattファイルBを作成します。
3. Excelファイルに必要な情報を入力します。
4. dattファイルBの中で、`%require`ディレクティブを使ってdattファイルAを読み込ませます。
5. dattファイルBの中で、`%include`ディレクティブを使って、dattファイルAで定義したリソースを取り込みます。
6. dattファイルBの不要になったパラメータ設定を削除します。
